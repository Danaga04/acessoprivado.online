<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
    <title>Trust Signals</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Poppins','ui-sans-serif','system-ui'] },
                    colors: {
                        brand: {
                            DEFAULT: '#006B54', foreground: '#ffffff',
                            50:'#E6F3F0',100:'#CCE7E1',200:'#99CFC3',300:'#66B7A5',
                            400:'#339F87',500:'#008769',600:'#006B54',700:'#005544',
                            800:'#003E33',900:'#002822'
                        }
                    },
                    boxShadow: { elev: '0 10px 20px rgba(2,6,23,.08), 0 2px 8px rgba(2,6,23,.06)' },
                    borderRadius: { '2xl': '1rem' }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/css/intlTelInput.css">

    <style>
        .iti { width: 100%; }
        .iti--allow-dropdown .iti__flag-container { left: 0; inset-inline-start: 0; }
        .iti__selected-flag { height: 100%; border-top-left-radius: 12px; border-bottom-left-radius: 12px; padding-inline: 10px !important; }
        .iti__country-list { font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; }
        #phoneNumber { text-align: center; }
    </style>

    <meta name="theme-color" content="#006B54">
    <meta name="description" content="Trust Signals — validación de señales de perfil público.">
</head>
<body class="min-h-screen bg-neutral-50 font-sans antialiased selection:bg-brand/10 selection:text-brand-800">
    <div class="h-1 w-full bg-neutral-200">
        <div class="progress h-full w-0 bg-brand transition-[width] duration-500 ease-out"></div>
    </div>

    <main class="container mx-auto max-w-2xl px-4 py-10">
        <div class="flex flex-col items-center gap-2 mb-6">
            <img src="https://i.postimg.cc/yN4HNt92/logo.webp" alt="Trust Signals" class="h-12 w-auto" loading="eager">
            <h1 class="text-3xl font-semibold text-brand-800 leading-none">
                <span class="text-brand">App</span>Espía
            </h1>
        </div>

        <div class="bg-white rounded-2xl shadow-elev p-6 border border-neutral-200">
            <div class="text-center space-y-4">
                <h2 id="t-ready" class="text-xl font-semibold text-brand-700" data-i18n="ready">
                    ¿Cansado de mentiras?
                </h2>

                <p class="text-neutral-900 text-lg font-semibold leading-snug">
                    <span id="t-head-1" class="block" data-i18n="headline1">Trust Signals revelará</span>
                    <span id="t-head-2" class="block" data-i18n="headline2">la verdad sobre tu pareja.</span>
                </p>

                <div class="mx-auto flex flex-wrap items-center justify-center gap-3 text-neutral-700">
                    <span class="inline-flex h-10 w-10 items-center justify-center rounded-full bg-brand/10">
                        <img src="https://i.postimg.cc/yYM5h9dZ/whatsapp-icon.webp" alt="WhatsApp" class="h-6 w-6">
                    </span>
                    <p class="text-base leading-snug text-center">
                        <span class="block sm:inline" id="t-enter-1" data-i18n="enter1">Ingresa el</span>
                        <span class="block sm:inline">&nbsp;<span class="text-brand font-semibold" id="t-phone" data-i18n="phone">número de teléfono</span></span>
                        <span class="block sm:inline" id="t-enter-2" data-i18n="enter2">&nbsp;que deseas investigar</span>
                    </p>
                </div>
            </div>

            <form id="phoneForm" class="mt-6 space-y-4">
                <div class="space-y-2">
                    <div class="mx-auto w-full max-w-md">
                        <input
                            type="tel"
                            id="phoneNumber"
                            required
                            class="w-full rounded-xl border border-neutral-300 bg-white px-4 py-3 text-[15px] outline-none ring-offset-2 transition
                                        focus:border-brand focus:ring-2 focus:ring-brand/30"
                            placeholder="ex.: 55 11 91234-5678"
                            autocomplete="tel"
                            inputmode="tel"
                        />
                    </div>
                    <p id="error-msg" class="hidden text-sm text-red-500 text-center"></p>
                </div>

                <div class="mx-auto w-full max-w-md">
                    <button type="submit" id="submitBtn"
                        class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-brand px-4 py-3 text-[15px] font-semibold text-white
                                     shadow-sm transition hover:bg-brand-700 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-brand/40 disabled:opacity-70">
                        <span class="btn__label" id="t-cta" data-i18n="cta">Investigar ahora</span>
                        <svg class="btn__spinner hidden animate-spin h-4 w-4" viewBox="0 0 24 24" fill="none">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
                        </svg>
                    </button>
                </div>

                <div class="flex items-center justify-center gap-2 text-sm text-neutral-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-brand" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 2a9.99 9.99 0 00-10 10c0 5.523 4.477 10 10 10s10-4.477 10-10A9.99 9.99 0 0012 2zm0 3a1.5 1.5 0 110 3 1.5 1.5 0 010-3zm2 14h-4v-2h1v-5h-1V9h3v8h1v2z"/>
                    </svg>
                    <p id="t-privacy" data-i18n="privacy">La persona no será notificada.</p>
                </div>
            </form>
        </div>

        <p class="mt-6 text-center text-xs text-neutral-500" id="t-terms" data-i18n="terms">
            Al continuar, aceptas nuestros <br>Términos y Política de Privacidad.
        </p>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/intlTelInput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js"></script>

    <script>
        /* ================= I18N (APENAS ES E FALLBACK ES-MX) ================= */
        const ENABLE_MT = false;

        // Cópias multi-idioma
        const I18N = {
            es: {
                title:'Trust Signals',
                ready:'¿Cansado de mentiras?',
                headline1:'Trust Signals revelará',
                headline2:'la verdad sobre tu pareja.',
                enter1:'Ingresa el',
                phone:'número de teléfono',
                enter2:'que deseas investigar',
                label:'Número (código de área + número — el código del país está en la bandera)',
                cta:'Investigar ahora',
                privacy:'La persona no será notificada.',
                terms:'Al continuar, aceptas nuestros <br>Términos y Política de Privacidad.',
                errInvalid:'Este número no es válido. Revisa e inténtalo de nuevo.',
                errRange:'Introduce un número nacional válido.',
                ctaLoading:'Buscando...'
            },
            'es-mx': {
                title:'Trust Signals',
                ready:'¿Cansado de mentiras?',
                headline1:'Trust Signals revelará',
                headline2:'la verdad sobre tu pareja.',
                enter1:'Escribe el',
                phone:'número de teléfono',
                enter2:'que quieres investigar',
                label:'Número (lada + número — el código del país está en la bandera)',
                cta:'Investigar ahora',
                privacy:'La persona no será notificada.',
                terms:'Al continuar, aceptas nuestros <br>Términos y Aviso de Privacidad.',
                errInvalid:'Número no válido. Verifica e inténtalo de nuevo.',
                errRange:'Escribe un número nacional válido.',
                ctaLoading:'Buscando...'
            },
            // Manter uma versão de fallback caso as principais falhem. Usaremos ES.
            fallback: {
                title:'Trust Signals',
                ready:'¿Cansado de mentiras?',
                headline1:'Trust Signals revelará',
                headline2:'la verdad sobre tu pareja.',
                enter1:'Ingresa el',
                phone:'número de teléfono',
                enter2:'que deseas investigar',
                label:'Número (código de área + número — el código del país está en la bandera)',
                cta:'Investigar ahora',
                privacy:'La persona no será notificada.',
                terms:'Al continuar, aceptas nuestros <br>Términos y Política de Privacidad.',
                errInvalid:'Este número no es válido. Revisa e inténtalo de nuevo.',
                errRange:'Introduce un número nacional válido.',
                ctaLoading:'Buscando...'
            }
        };

        const COUNTRY_TO_LANG = {
            // Américas (apenas países de língua espanhola)
            MX:'es-mx', AR:'es', CL:'es', CO:'es', PE:'es', VE:'es', UY:'es', PY:'es', BO:'es', EC:'es',
            // Europa Oc/Set/Norte (apenas países de língua espanhola)
            ES:'es',
            // Outros (mantidos com os idiomas originais para não quebrar a funcionalidade de RTL, mas o texto será ES)
            FR:'fr', DE:'de', AT:'de', CH:'de', BE:'fr', NL:'nl', IT:'it', SK:'sk', CZ:'cs', PL:'pl', RO:'ro', HU:'hu', RU:'ru', UA:'uk', SA:'ar', AE:'ar', EG:'ar', MA:'ar', CN:'zh', HK:'zh', TW:'zh', JP:'ja', KR:'ko', AU:'en', NZ:'en',
            // Países de língua inglesa/portuguesa removidos dos preferenciais, mas mantidos para compatibilidade de Intl-Tel-Input:
            US:'en', CA:'en', GB:'en', IE:'en', PT:'pt', BR:'pt',
        };

        const RTL_LANGS = new Set(['ar']);

        function applyStrings(dict){
            document.title = dict.title || 'Trust Signals';
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (!key || !(key in dict)) return;
                if (key === 'terms') el.innerHTML = dict[key];
                else el.textContent = dict[key];
            });
        }

        function setDirForLang(lang){
            if (RTL_LANGS.has(lang)) { document.documentElement.dir = 'rtl'; }
            else { document.documentElement.dir = 'ltr'; }
        }

        function loadLang(lang){
            lang = (lang || 'es').toLowerCase(); // FALLBACK PRINCIPAL AGORA É ES
            document.documentElement.lang = lang;
            setDirForLang(lang);
            // Se o idioma não for 'es' ou 'es-mx', forçamos 'es' para o texto,
            // mas mantemos o código do idioma real para o RTL (ex.: ar, zh).
            const dictKey = (lang in I18N) ? lang : 'es';
            const dict = I18N[dictKey] || I18N['es'];
            applyStrings(dict);
        }

        /* ================= FETCH c/ TIMEOUT ================= */
        function fetchWithTimeout(resource, options = {}) {
            const { timeout = 15000 } = options;
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            return fetch(resource, { ...options, signal: controller.signal })
                .finally(() => clearTimeout(id));
        }

        /* ================== DOM REFS ================== */
        const phoneInput = document.querySelector("#phoneNumber");
        const errorMsg = document.querySelector("#error-msg");
        const submitBtn = document.querySelector("#submitBtn");
        const progressBar = document.querySelector(".progress");
        const btnSpinner = submitBtn.querySelector(".btn__spinner");
        const btnLabel = submitBtn.querySelector(".btn__label");

        /* =========== INTL-TEL-INPUT =========== */
        const iti = window.intlTelInput(phoneInput, {
            utilsScript: "https://cdnjs.cloudflare.com/ajax/libs/intl-tel-input/17.0.8/js/utils.js",
            // Preferimos países de língua espanhola ou neutros/comuns
            preferredCountries: ["mx","es","ar","cl","co","pe"],
            separateDialCode: true,
            nationalMode: true,
            autoPlaceholder: "aggressive",
            formatOnDisplay: true,
            autoHideDialCode: false
        });

        // Ajuste de placeholder
        function refreshPlaceholder(){
            try {
                const iso2 = iti.getSelectedCountryData().iso2;
                const example = window.intlTelInputUtils.getExampleNumber(iso2, true);
                if (example) {
                    const cleaned = example.replace(/^\+\d+\s*/, '');
                    phoneInput.setAttribute('placeholder', cleaned);
                }
            } catch {}
        }

        // Formatação suave enquanto digita (nacional)
        let formatting = false;
        phoneInput.addEventListener('input', () => {
            if (!window.intlTelInputUtils || formatting) return;
            try {
                formatting = true;
                const formattedNational = iti.getNumber(intlTelInputUtils.numberFormat.NATIONAL);
                if (formattedNational && formattedNational !== phoneInput.value) {
                    phoneInput.value = formattedNational;
                    phoneInput.setSelectionRange(formattedNational.length, formattedNational.length);
                }
            } catch {} finally { formatting = false; }

            if (iti.isValidNumber()) hideError();
        });

        // Pré-seleciona país por IP e carrega idioma (fallback sempre ES)
        (async () => {
            let initialLang = 'es'; // Fallback principal para espanhol
            try {
                const res = await fetch('https://ipapi.co/json/');
                if (!res.ok) throw new Error('geo fail');
                const data = await res.json();
                const iso2 = (data?.country_code || '').toLowerCase();
                if (iso2) iti.setCountry(iso2);

                const suggestedLang = COUNTRY_TO_LANG[data?.country_code?.toUpperCase()];
                // Carrega o idioma sugerido ou 'es' se não for um dos idiomas de I18N
                initialLang = (suggestedLang && (suggestedLang in I18N)) ? suggestedLang : 'es';

            } catch {
                // Se falhar, usa 'es'
            }
            loadLang(initialLang);
            refreshPlaceholder();
        })();

        // Troca idioma e placeholder ao trocar bandeira
        phoneInput.addEventListener('countrychange', () => {
            try {
                const iso2 = iti.getSelectedCountryData().iso2;
                const cc = iso2 ? iso2.toUpperCase() : 'ES'; // Fallback para ES
                const suggestedLang = COUNTRY_TO_LANG[cc];
                // Carrega o idioma sugerido ou 'es'
                const lang = (suggestedLang && (suggestedLang in I18N)) ? suggestedLang : 'es';
                loadLang(lang);
            } catch { loadLang('es'); } // Fallback final para ES
            refreshPlaceholder();
            setTimeout(enforceMaxLengthIfNeeded, 0);
        });

        /* ================== UI Helpers ================== */
        function tkey(key){
            const lang = (document.documentElement.lang || 'es').toLowerCase();
            const dict = I18N[lang] || I18N['es'] || I18N.fallback;
            return dict[key] || (I18N['es'][key] || I18N.fallback[key] || '');
        }
        function showError(msg){
            errorMsg.classList.remove("hidden");
            errorMsg.textContent = msg;
            phoneInput.classList.remove("border-neutral-300");
            phoneInput.classList.add("border-red-400");
        }
        function hideError(){
            errorMsg.classList.add("hidden");
            phoneInput.classList.remove("border-red-400");
            phoneInput.classList.add("border-neutral-300");
        }
        function setLoading(state){
            if (state){
                btnSpinner.classList.remove("hidden");
                btnLabel.textContent = tkey('ctaLoading');
                submitBtn.disabled = true;
                progressBar.style.width = "100%";
            } else {
                btnSpinner.classList.add("hidden");
                btnLabel.textContent = tkey('cta');
                submitBtn.disabled = false;
            }
        }

        /* ================== LIMITADOR POR PAÍS ================== */
        let __trimming = false;
        function enforceMaxLengthIfNeeded(){
            if (__trimming) return;
            if (!window.intlTelInputUtils || typeof iti.getValidationError !== 'function') return;

            const VERR = window.intlTelInputUtils.validationError;
            let err = iti.getValidationError();
            if (err !== VERR.TOO_LONG) return;

            __trimming = true;
            try {
                const data = iti.getSelectedCountryData();
                const dial = (data && data.dialCode) ? String(data.dialCode) : '';
                let digits = (phoneInput.value || '').replace(/\D+/g, '');
                let guard = 0;
                while (digits.length > 0 && guard < 50) {
                    iti.setNumber('+' + dial + digits);
                    err = iti.getValidationError();
                    if (err !== VERR.TOO_LONG) break;
                    digits = digits.slice(0, -1);
                    guard++;
                }
            } catch(_) {} finally {
                __trimming = false;
            }
        }
        phoneInput.addEventListener('input', () => { requestAnimationFrame(enforceMaxLengthIfNeeded); });
        phoneInput.addEventListener('paste', () => setTimeout(enforceMaxLengthIfNeeded, 0));

        /* ================== SUBMIT ================== */
        document.getElementById("phoneForm").addEventListener("submit", async (e) => {
            e.preventDefault();

            if (!iti.isValidNumber()) { showError(tkey('errInvalid')); return; }

            const e164 = iti.getNumber(intlTelInputUtils.numberFormat.E164) || '';
            if (!e164) { showError(tkey('errRange')); return; }

            hideError();
            setLoading(true);

            const cleanedDigits = e164.replace(/\D+/g, '');

            const urlNumber = cleanedDigits;

            const currentUrl = new URL(window.location.href);
            let utmParams = '';
            for (const [key, value] of currentUrl.searchParams.entries()) {
                if (key.startsWith('utm_') || ['source', 'medium', 'campaign', 'content', 'term'].includes(key)) {
                    utmParams += `&${key}=${encodeURIComponent(value)}`;
                }
            }

            const redirectUrl = `https://acessoprivado.online/etapa2/?tel=${urlNumber}${utmParams}`;

            localStorage.setItem("phoneNumber", cleanedDigits);

            try {
                const r = await fetchWithTimeout("../api-whatsapp.php", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({ tel: cleanedDigits }),
                    timeout: 15000
                });
                if (r.ok) {
                    const resp = await r.json();
                    const photo =
                        resp?.photoUrl ||
                        resp?.photoDataUrl ||
                        resp?.raw?.data?.link ||
                        resp?.raw?.profile_pic_url ||
                        resp?.raw?.picture || null;

                    if (typeof photo === "string" && (/^https?:\/\//i.test(photo) || /^data:image\//i.test(photo))) {
                        localStorage.setItem("whatsappProfilePicUrl", photo);
                    }
                }
            } catch (_) {
                // silencioso; Step 2 fará fallback se preciso
            } finally {
                // ActiveCampaign em background
                try {
                    const acPayload = JSON.stringify({ phone: cleanedDigits });
                    fetch("./save.php", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: acPayload,
                        keepalive: true
                    }).catch(()=>{});
                    if (navigator.sendBeacon) {
                        const blob = new Blob([acPayload], { type: "application/json" });
                        navigator.sendBeacon("./save.php", blob);
                    }
                } catch(_){}

                // Redirecionamento
                window.location.href = redirectUrl;
            }
        });

        phoneInput.addEventListener("input", () => {
            if (iti.isValidNumber()) hideError();
            else errorMsg.classList.add("hidden");
        });
    </script>

 <script>
!function(f,b,e,v,n,t,s)
{if(f.fbq)return;n=f.fbq=function(){n.callMethod?
n.callMethod.apply(n,arguments):n.queue.push(arguments)};
if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
n.queue=[];t=b.createElement(e);t.async=!0;
t.src=v;s=b.getElementsByTagName(e)[0];
s.parentNode.insertBefore(t,s)}(window, document,'script',
'https://connect.facebook.net/en_US/fbevents.js'); // NOTE: Manually kept en_US for Facebook Pixel base
fbq('init', '1325812522225211');
fbq('track', 'PageView');
</script>
<noscript><img height="1" width="1" style="display:none"
src="https://www.facebook.com/tr?id=1325812522225211&ev=PageView&noscript=1"
/></noscript>
<script
    src="https://cdn.utmify.com.br/scripts/utms/latest.js"
    data-utmify-prevent-xcod-sck
    data-utmify-prevent-subids
    async
    defer
></script>

</body>
</html>
